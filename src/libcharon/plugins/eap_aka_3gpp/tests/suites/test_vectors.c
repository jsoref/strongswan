/*
 * Copyright (C) 2018 Tobias Brunner
 * HSR Hochschule fuer Technik Rapperswil
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the
 * Free Software Foundation; either version 2 of the License, or (at your
 * option) any later version.  See <http://www.fsf.org/copyleft/gpl.txt>.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * for more details.
 */

#include <test_suite.h>

#include "../eap_aka_3gpp_functions.h"

static eap_aka_3gpp_functions_t *functions;

START_SETUP(functions_setup)
{
	functions = eap_aka_3gpp_functions_create();
	ck_assert(functions);
}
END_SETUP

START_TEARDOWN(functions_teardown)
{
	functions->destroy(functions);
}
END_TEARDOWN

/**
 * Test vectors from 3GPP TS 35.207
 */
static struct {
	uint8_t k[AKA_K_LEN];
	uint8_t rand[AKA_RAND_LEN];
	uint8_t sqn[AKA_SQN_LEN];
	uint8_t amf[AKA_AMF_LEN];
	uint8_t opc[AKA_OPC_LEN];
	uint8_t f1[AKA_MAC_LEN];
	uint8_t f1star[AKA_MAC_LEN];
	uint8_t f2[AKA_RES_LEN];
	uint8_t f3[AKA_CK_LEN];
	uint8_t f4[AKA_IK_LEN];
	uint8_t f5[AKA_AK_LEN];
	uint8_t f5star[AKA_AK_LEN];
} test_data[] = {
	{
		.k = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.rand = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.sqn = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.amf = {0xFF,0xFF},
		.opc = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f2 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f3 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f4 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
	},
	{
		.k = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.rand = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.sqn = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.amf = {0xFF,0xFF},
		.opc = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f2 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f3 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f4 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
	},
	{
		.k = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.rand = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.sqn = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.amf = {0xFF,0xFF},
		.opc = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f2 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f3 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f4 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
	},
	{
		.k = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.rand = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.sqn = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.amf = {0xFF,0xFF},
		.opc = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f2 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f3 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f4 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
	},
	{
		.k = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.rand = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.sqn = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.amf = {0xFF,0xFF},
		.opc = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f2 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f3 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f4 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
	},
	{
		.k = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.rand = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.sqn = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.amf = {0xFF,0xFF},
		.opc = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f1star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f2 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f3 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f4 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5 = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
		.f5star = {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
	},
};

START_TEST(test_f1)
{
	uint8_t mac[AKA_MAC_LEN];

	ck_assert(functions->f1(functions, test_data[_i].k, test_data[_i].opc,
							test_data[_i].rand, test_data[_i].sqn,
							test_data[_i].amf, mac));
	ck_assert(memeq(test_data[_i].f1, mac, sizeof(mac)));
}
END_TEST

START_TEST(test_f1star)
{
	uint8_t mac[AKA_MAC_LEN];

	ck_assert(functions->f1star(functions, test_data[_i].k,
							test_data[_i].opc, test_data[_i].rand,
							test_data[_i].sqn, test_data[_i].amf, mac));
	ck_assert(memeq(test_data[_i].f1star, mac, sizeof(mac)));
}
END_TEST

START_TEST(test_f2345)
{
	uint8_t res[AKA_RES_LEN], ck[AKA_CK_LEN], ik[AKA_IK_LEN], ak[AKA_AK_LEN];

	ck_assert(functions->f2345(functions, test_data[_i].k,
							test_data[_i].opc, test_data[_i].rand,
							res, ck, ik, ak));

	ck_assert(memeq(test_data[_i].f2, res, sizeof(res)));
	ck_assert(memeq(test_data[_i].f3, ck, sizeof(ck)));
	ck_assert(memeq(test_data[_i].f4, ik, sizeof(ik)));
	ck_assert(memeq(test_data[_i].f5, ak, sizeof(ak)));
}
END_TEST

START_TEST(test_f5star)
{
	uint8_t ak[AKA_AK_LEN];

	ck_assert(functions->f5star(functions, test_data[_i].k,
							test_data[_i].opc, test_data[_i].rand, ak));

	ck_assert(memeq(test_data[_i].f5star, ak, sizeof(ak)));
}
END_TEST

Suite *test_vectors_suite_create()
{
	Suite *s;
	TCase *tc;

	s = suite_create("eap-aka-3gpp");

	tc = tcase_create("f1, f1*");
	tcase_add_checked_fixture(tc, functions_setup, functions_teardown);
	tcase_add_loop_test(tc, test_f1, 0, countof(test_data));
	tcase_add_loop_test(tc, test_f1star, 0, countof(test_data));
	suite_add_tcase(s, tc);

	tc = tcase_create("f2, f3, f4 and f5");
	tcase_add_checked_fixture(tc, functions_setup, functions_teardown);
	tcase_add_loop_test(tc, test_f2345, 0, countof(test_data));
	suite_add_tcase(s, tc);

	tc = tcase_create("f5*");
	tcase_add_checked_fixture(tc, functions_setup, functions_teardown);
	tcase_add_loop_test(tc, test_f5star, 0, countof(test_data));
	suite_add_tcase(s, tc);

	return s;
}
